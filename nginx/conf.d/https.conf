# =============================================\n# HTTPS CONFIGURATION - CMM AUTOMACAO PLATFORM\n# Version: 2.2\n# Updated: 2025-08-26\n# =============================================\n\n# Este arquivo só é incluído se os certificados SSL existirem\n\n# =========================================\n# SERVIDOR HTTPS PRINCIPAL - PORT 443\n# =========================================\n\nserver {\n    listen 443 ssl http2;\n    listen [::]:443 ssl http2;\n    server_name automacao.cmm.am.gov.br 172.18.1.32 _;\n    \n    # SSL Configuration - só ativa se certificados existirem\n    ssl_certificate /etc/ssl/certs/server.crt;\n    ssl_certificate_key /etc/ssl/certs/server.key;\n    \n    # SSL Security - Modern configuration\n    ssl_protocols TLSv1.2 TLSv1.3;\n    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;\n    ssl_prefer_server_ciphers off;\n    ssl_session_cache shared:SSL:50m;\n    ssl_session_timeout 1d;\n    ssl_session_tickets off;\n    \n    # OCSP stapling\n    ssl_stapling on;\n    ssl_stapling_verify on;\n    \n    # HSTS\n    add_header Strict-Transport-Security \"max-age=63072000; includeSubDomains; preload\" always;\n    \n    root /usr/share/nginx/html;\n    index index.html index.htm;\n    \n    # Rate limiting\n    limit_req zone=general burst=50 nodelay;\n    limit_conn perip 20;\n    \n    # Expires headers\n    expires $expires;\n    \n    # API Backend\n    location /api/ {\n        access_log /var/log/nginx/api_access_ssl.log api_format;\n        \n        # Rate limiting específico para API\n        limit_req zone=api burst=20 nodelay;\n        \n        # Proxy settings\n        proxy_pass http://api_backend/;\n        proxy_http_version 1.1;\n        \n        # Headers\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_set_header X-Request-ID $request_id;\n        \n        # WebSocket support\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection $connection_upgrade;\n        \n        # Timeouts\n        proxy_connect_timeout 10s;\n        proxy_send_timeout 60s;\n        proxy_read_timeout 60s;\n        \n        # Buffering\n        proxy_buffering on;\n        proxy_buffer_size 4k;\n        proxy_buffers 8 4k;\n    }\n    \n    # Swagger Documentation\n    location /api/docs {\n        access_log /var/log/nginx/swagger_access_ssl.log main_detailed;\n        \n        proxy_pass http://api_backend/api/docs;\n        proxy_http_version 1.1;\n        \n        # Headers básicos\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        \n        # Timeouts\n        proxy_connect_timeout 5s;\n        proxy_send_timeout 30s;\n        proxy_read_timeout 30s;\n    }\n    \n    # Grafana Service\n    location /grafana/ {\n        # Rate limiting\n        limit_req zone=general burst=30 nodelay;\n        \n        proxy_pass http://grafana_backend/;\n        proxy_http_version 1.1;\n        \n        # Headers básicos\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        \n        # Headers específicos do Grafana\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection $connection_upgrade;\n        \n        # Timeouts aumentados para Grafana\n        proxy_connect_timeout 15s;\n        proxy_send_timeout 120s;\n        proxy_read_timeout 120s;\n        \n        # Buffering otimizado\n        proxy_buffering off;\n        proxy_cache_bypass $http_upgrade;\n        \n        # Redirecionamentos\n        proxy_redirect http://grafana:4000/ /grafana/;\n        proxy_redirect default;\n    }\n    \n    # Frontend React - SPA routing\n    location / {\n        try_files $uri $uri/ /index.html;\n        \n        # Headers para SPA\n        add_header Cache-Control \"no-cache, no-store, must-revalidate\" always;\n        add_header Pragma \"no-cache\" always;\n        add_header Expires \"0\" always;\n    }\n    \n    # Health check\n    location /health {\n        access_log off;\n        return 200 'Nginx HTTPS Server: OK\\nTimestamp: $time_iso8601\\nServer: $hostname\\nSSL: Enabled\\n';\n        add_header Content-Type text/plain;\n    }\n}\n\n# =========================================\n# SUBDOMÍNIO GRAFANA - grafana.cmm.am.gov.br\n# =========================================\n\nserver {\n    listen 80;\n    listen 443 ssl http2;\n    listen [::]:80;\n    listen [::]:443 ssl http2;\n    server_name grafana.cmm.am.gov.br;\n\n    # SSL Configuration (só se certificados existirem)\n    ssl_certificate /etc/ssl/certs/server.crt;\n    ssl_certificate_key /etc/ssl/certs/server.key;\n    ssl_protocols TLSv1.2 TLSv1.3;\n    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;\n    ssl_prefer_server_ciphers off;\n    ssl_session_cache shared:SSL:10m;\n    ssl_session_timeout 10m;\n\n    # Security\n    server_tokens off;\n    add_header Strict-Transport-Security \"max-age=31536000; includeSubDomains\" always;\n\n    # Proxy direto para Grafana\n    location / {\n        proxy_pass http://grafana_backend/;\n        \n        # Headers básicos\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        \n        # Headers específicos do Grafana\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection $connection_upgrade;\n        proxy_cache_bypass $http_upgrade;\n        proxy_buffering off;\n        proxy_http_version 1.1;\n        \n        # Timeouts\n        proxy_connect_timeout 10s;\n        proxy_send_timeout 60s;\n        proxy_read_timeout 60s;\n    }\n}