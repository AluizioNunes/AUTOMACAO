# =============================================\n# NGINX CONFIGURATION - CMM AUTOMACAO PLATFORM\n# Version: 2.1\n# Updated: 2025-08-26\n# =============================================\n\n# Configuração global do Nginx\nuser nginx;\nworker_processes auto;\nworker_rlimit_nofile 65535;\nerror_log /var/log/nginx/error.log notice;\npid /var/run/nginx.pid;\n\nevents {\n    worker_connections 2048;\n    use epoll;\n    multi_accept on;\n    accept_mutex off;\n}\n\nhttp {\n    # =========================================\n    # CONFIGURAÇÕES BÁSICAS\n    # =========================================\n    \n    include       /etc/nginx/mime.types;\n    default_type  application/octet-stream;\n    \n    # Charset padrão\n    charset utf-8;\n    \n    # Server tokens\n    server_tokens off;\n    \n    # =========================================\n    # LOGGING CONFIGURATION\n    # =========================================\n    \n    # Formato de log detalhado\n    log_format main_detailed \n        '$remote_addr - $remote_user [$time_local] '\n        '\"$request\" $status $body_bytes_sent '\n        '\"$http_referer\" \"$http_user_agent\" '\n        '\"$http_x_forwarded_for\" '\n        'rt=$request_time '\n        'uct=\"$upstream_connect_time\" '\n        'uht=\"$upstream_header_time\" '\n        'urt=\"$upstream_response_time\" '\n        'host=\"$host\" '\n        'scheme=\"$scheme\" '\n        'request_id=\"$request_id\"';\n\n    # Formato de log para APIs\n    log_format api_format \n        '$remote_addr - $remote_user [$time_local] '\n        '\"$request\" $status $body_bytes_sent '\n        'rt=$request_time '\n        'api_endpoint=\"$uri\" '\n        'method=\"$request_method\" '\n        'user_agent=\"$http_user_agent\"';\n\n    # Logs principais\n    access_log /var/log/nginx/access.log main_detailed;\n    error_log  /var/log/nginx/error.log warn;\n    \n    # =========================================\n    # PERFORMANCE OPTIMIZATION\n    # =========================================\n    \n    # File handling\n    sendfile            on;\n    sendfile_max_chunk  1m;\n    tcp_nopush          on;\n    tcp_nodelay         on;\n    \n    # Timeouts\n    keepalive_timeout   65;\n    keepalive_requests  1000;\n    client_header_timeout 60s;\n    client_body_timeout 60s;\n    send_timeout 60s;\n    \n    # Buffer sizes\n    client_body_buffer_size 128k;\n    client_header_buffer_size 1k;\n    large_client_header_buffers 4 4k;\n    client_max_body_size 50M;\n    \n    # Hash tables\n    types_hash_max_size 4096;\n    server_names_hash_bucket_size 128;\n    \n    # =========================================\n    # GZIP COMPRESSION\n    # =========================================\n    \n    gzip on;\n    gzip_vary on;\n    gzip_min_length 1024;\n    gzip_proxied any;\n    gzip_comp_level 6;\n    gzip_types\n        text/plain\n        text/css\n        text/xml\n        text/javascript\n        text/csv\n        application/json\n        application/javascript\n        application/xml+rss\n        application/atom+xml\n        application/rdf+xml\n        image/svg+xml\n        font/truetype\n        font/opentype\n        application/font-woff\n        application/font-woff2;\n\n    gzip_disable \"msie6\";\n    \n    # =========================================\n    # SECURITY HEADERS\n    # =========================================\n    \n    # Security headers globais\n    add_header X-Frame-Options \"SAMEORIGIN\" always;\n    add_header X-Content-Type-Options \"nosniff\" always;\n    add_header X-XSS-Protection \"1; mode=block\" always;\n    add_header Referrer-Policy \"strict-origin-when-cross-origin\" always;\n    add_header Permissions-Policy \"camera=(), microphone=(), geolocation=()\" always;\n    \n    # Content Security Policy (ajustar conforme necessário)\n    add_header Content-Security-Policy \"default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self'; frame-ancestors 'self';\" always;\n    \n    # =========================================\n    # RATE LIMITING\n    # =========================================\n    \n    # Zonas de rate limiting\n    limit_req_zone $binary_remote_addr zone=api:20m rate=30r/m;\n    limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;\n    limit_req_zone $binary_remote_addr zone=general:20m rate=100r/m;\n    limit_req_zone $binary_remote_addr zone=static:10m rate=200r/m;\n    \n    # Connection limiting\n    limit_conn_zone $binary_remote_addr zone=perip:10m;\n    limit_conn_zone $server_name zone=perserver:10m;\n    \n    # =========================================\n    # UPSTREAM CONFIGURATIONS\n    # =========================================\n    \n    # Backend API upstream\n    upstream api_backend {\n        least_conn;\n        server backend:3001 max_fails=3 fail_timeout=30s weight=1;\n        keepalive 32;\n        keepalive_requests 1000;\n        keepalive_timeout 60s;\n    }\n    \n    # Grafana upstream\n    upstream grafana_backend {\n        least_conn;\n        server grafana:4000 max_fails=3 fail_timeout=30s weight=1;\n        keepalive 16;\n        keepalive_requests 500;\n        keepalive_timeout 60s;\n    }\n    \n    # Frontend upstream\n    upstream frontend_backend {\n        server frontend:80 max_fails=2 fail_timeout=20s;\n        keepalive 8;\n    }\n    \n    # =========================================\n    # MAP CONFIGURATIONS\n    # =========================================\n    \n    # Map para definir cache control baseado no tipo de arquivo\n    map $sent_http_content_type $expires {\n        default                    off;\n        text/html                  epoch;\n        text/css                   1y;\n        application/javascript     1y;\n        application/json           off;\n        ~image/                    1M;\n        ~font/                     1y;\n    }\n    \n    # Map para upgrade de conexão WebSocket\n    map $http_upgrade $connection_upgrade {\n        default upgrade;\n        '' close;\n    }\n    \n    # =========================================\n    # SERVIDOR HTTP PRINCIPAL - PORT 80\n    # =========================================\n    \n    server {\n        listen 80 default_server;\n        listen [::]:80 default_server;\n        server_name automacao.cmm.am.gov.br 172.18.1.32 _;\n        \n        root /usr/share/nginx/html;\n        index index.html index.htm;\n        \n        # Rate limiting\n        limit_req zone=general burst=50 nodelay;\n        limit_conn perip 20;\n        \n        # Expires headers\n        expires $expires;\n        \n        # Redirecionar HTTP para HTTPS se SSL estiver disponível\n        location /.well-known/ {\n            # Permite validação ACME para LetsEncrypt\n            root /var/www/html;\n        }\n        \n        location / {\n            # Se SSL estiver configurado, redirecionar para HTTPS\n            if (-f /etc/ssl/certs/server.crt) {\n                return 301 https://$host$request_uri;\n            }\n            \n            # Se não tiver SSL, servir conteúdo normalmente\n            try_files $uri $uri/ /index.html;\n        }\n        \n        # API Backend\n        location /api/ {\n            access_log /var/log/nginx/api_access.log api_format;\n            \n            # Rate limiting específico para API\n            limit_req zone=api burst=20 nodelay;\n            \n            # Proxy settings\n            proxy_pass http://api_backend/;\n            proxy_http_version 1.1;\n            \n            # Headers\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto $scheme;\n            proxy_set_header X-Request-ID $request_id;\n            \n            # WebSocket support\n            proxy_set_header Upgrade $http_upgrade;\n            proxy_set_header Connection $connection_upgrade;\n            \n            # Timeouts\n            proxy_connect_timeout 10s;\n            proxy_send_timeout 60s;\n            proxy_read_timeout 60s;\n            \n            # Buffering\n            proxy_buffering on;\n            proxy_buffer_size 4k;\n            proxy_buffers 8 4k;\n        }\n        \n        # Swagger Documentation\n        location /api/docs {\n            access_log /var/log/nginx/swagger_access.log main_detailed;\n            \n            proxy_pass http://api_backend/api/docs;\n            proxy_http_version 1.1;\n            \n            # Headers básicos\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto $scheme;\n            \n            # Timeouts\n            proxy_connect_timeout 5s;\n            proxy_send_timeout 30s;\n            proxy_read_timeout 30s;\n        }\n        \n        # Grafana Service\n        location /grafana/ {\n            # Rate limiting\n            limit_req zone=general burst=30 nodelay;\n            \n            proxy_pass http://grafana_backend/;\n            proxy_http_version 1.1;\n            \n            # Headers básicos\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto $scheme;\n            \n            # Headers específicos do Grafana\n            proxy_set_header Upgrade $http_upgrade;\n            proxy_set_header Connection $connection_upgrade;\n            \n            # Timeouts aumentados para Grafana\n            proxy_connect_timeout 15s;\n            proxy_send_timeout 120s;\n            proxy_read_timeout 120s;\n            \n            # Buffering otimizado\n            proxy_buffering off;\n            proxy_cache_bypass $http_upgrade;\n            \n            # Redirecionamentos\n            proxy_redirect http://grafana:4000/ /grafana/;\n            proxy_redirect default;\n        }\n        \n        # Health check simples\n        location /health {\n            access_log off;\n            return 200 'Nginx HTTP Server: OK\\nTimestamp: $time_iso8601\\nServer: $hostname\\nVersion: nginx/1.28.0\\n';\n            add_header Content-Type text/plain;\n        }\n    }\n\n    # =========================================\n    # SERVIDOR HTTPS PRINCIPAL - PORT 443\n    # =========================================\n    \n    server {\n        listen 443 ssl http2;\n        listen [::]:443 ssl http2;\n        server_name automacao.cmm.am.gov.br 172.18.1.32 _;\n        \n        root /usr/share/nginx/html;\n        index index.html index.htm;\n        \n        # SSL Configuration - só ativa se certificados existirem\n        ssl_certificate /etc/ssl/certs/server.crt;\n        ssl_certificate_key /etc/ssl/certs/server.key;\n        \n        # SSL Security - Modern configuration\n        ssl_protocols TLSv1.2 TLSv1.3;\n        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;\n        ssl_prefer_server_ciphers off;\n        ssl_session_cache shared:SSL:50m;\n        ssl_session_timeout 1d;\n        ssl_session_tickets off;\n        \n        # OCSP stapling\n        ssl_stapling on;\n        ssl_stapling_verify on;\n        \n        # HSTS\n        add_header Strict-Transport-Security \"max-age=63072000; includeSubDomains; preload\" always;\n        \n        # Rate limiting\n        limit_req zone=general burst=50 nodelay;\n        limit_conn perip 20;\n        \n        # Expires headers\n        expires $expires;\n        \n        # API Backend\n        location /api/ {\n            access_log /var/log/nginx/api_access_ssl.log api_format;\n            \n            # Rate limiting específico para API\n            limit_req zone=api burst=20 nodelay;\n            \n            # Proxy settings\n            proxy_pass http://api_backend/;\n            proxy_http_version 1.1;\n            \n            # Headers\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto $scheme;\n            proxy_set_header X-Request-ID $request_id;\n            \n            # WebSocket support\n            proxy_set_header Upgrade $http_upgrade;\n            proxy_set_header Connection $connection_upgrade;\n            \n            # Timeouts\n            proxy_connect_timeout 10s;\n            proxy_send_timeout 60s;\n            proxy_read_timeout 60s;\n            \n            # Buffering\n            proxy_buffering on;\n            proxy_buffer_size 4k;\n            proxy_buffers 8 4k;\n        }\n        \n        # Swagger Documentation\n        location /api/docs {\n            access_log /var/log/nginx/swagger_access_ssl.log main_detailed;\n            \n            proxy_pass http://api_backend/api/docs;\n            proxy_http_version 1.1;\n            \n            # Headers básicos\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto $scheme;\n            \n            # Timeouts\n            proxy_connect_timeout 5s;\n            proxy_send_timeout 30s;\n            proxy_read_timeout 30s;\n        }\n        \n        # Grafana Service\n        location /grafana/ {\n            # Rate limiting\n            limit_req zone=general burst=30 nodelay;\n            \n            proxy_pass http://grafana_backend/;\n            proxy_http_version 1.1;\n            \n            # Headers básicos\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto $scheme;\n            \n            # Headers específicos do Grafana\n            proxy_set_header Upgrade $http_upgrade;\n            proxy_set_header Connection $connection_upgrade;\n            \n            # Timeouts aumentados para Grafana\n            proxy_connect_timeout 15s;\n            proxy_send_timeout 120s;\n            proxy_read_timeout 120s;\n            \n            # Buffering otimizado\n            proxy_buffering off;\n            proxy_cache_bypass $http_upgrade;\n            \n            # Redirecionamentos\n            proxy_redirect http://grafana:4000/ /grafana/;\n            proxy_redirect default;\n        }\n        \n        # Frontend React - SPA routing\n        location / {\n            try_files $uri $uri/ /index.html;\n            \n            # Headers para SPA\n            add_header Cache-Control \"no-cache, no-store, must-revalidate\" always;\n            add_header Pragma \"no-cache\" always;\n            add_header Expires \"0\" always;\n        }\n        \n        # Health check\n        location /health {\n            access_log off;\n            return 200 'Nginx HTTPS Server: OK\\nTimestamp: $time_iso8601\\nServer: $hostname\\nSSL: Enabled\\n';\n            add_header Content-Type text/plain;\n        }\n    }\n\n    # =========================================\n    # SUBDOMÍNIO GRAFANA - grafana.cmm.am.gov.br\n    # =========================================\n    \n    server {\n        listen 80;\n        listen 443 ssl http2;\n        listen [::]:80;\n        listen [::]:443 ssl http2;\n        server_name grafana.cmm.am.gov.br;\n\n        # SSL Configuration (só se certificados existirem)\n        ssl_certificate /etc/ssl/certs/server.crt;\n        ssl_certificate_key /etc/ssl/certs/server.key;\n        ssl_protocols TLSv1.2 TLSv1.3;\n        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;\n        ssl_prefer_server_ciphers off;\n        ssl_session_cache shared:SSL:10m;\n        ssl_session_timeout 10m;\n\n        # Security\n        server_tokens off;\n        add_header Strict-Transport-Security \"max-age=31536000; includeSubDomains\" always;\n\n        # Proxy direto para Grafana\n        location / {\n            proxy_pass http://grafana_backend/;\n            \n            # Headers básicos\n            proxy_set_header Host $host;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto $scheme;\n            \n            # Headers específicos do Grafana\n            proxy_set_header Upgrade $http_upgrade;\n            proxy_set_header Connection $connection_upgrade;\n            proxy_cache_bypass $http_upgrade;\n            proxy_buffering off;\n            proxy_http_version 1.1;\n            \n            # Timeouts\n            proxy_connect_timeout 10s;\n            proxy_send_timeout 60s;\n            proxy_read_timeout 60s;\n        }\n    }\n\n    # =========================================\n    # SERVIDOR ADMIN/MONITORING - PORT 8080\n    # =========================================\n    \n    server {\n        listen 8080;\n        listen [::]:8080;\n        server_name _;\n        \n        # Security\n        server_tokens off;\n        \n        # Acesso restrito por IP\n        allow 127.0.0.1;\n        allow 172.0.0.0/8;\n        allow 10.0.0.0/8;\n        deny all;\n\n        # Página de administração\n        location / {\n            return 200 '<!DOCTYPE html>\n<html>\n<head><title>CMM Nginx Admin</title></head>\n<body>\n<h1>CMM Automação - Nginx Admin Panel</h1>\n<ul>\n<li><a href=\"/health\">Health Check</a></li>\n<li><a href=\"/status\">Server Status</a></li>\n<li><a href=\"/metrics\">Metrics</a></li>\n<li><a href=\"/logs\">Logs</a></li>\n</ul>\n</body>\n</html>';\n            add_header Content-Type text/html;\n        }\n\n        # Health check administrativo\n        location /health {\n            access_log off;\n            return 200 'Admin Panel Health: OK\\nAll Services: Operational\\n';\n            add_header Content-Type text/plain;\n        }\n\n        # Status geral dos serviços\n        location /status {\n            access_log off;\n            return 200 'Admin Status Dashboard\n===================\nNginx: Active\nBackend API: Operational\nGrafana: Operational\nTimestamp: $time_iso8601\n';\n            add_header Content-Type text/plain;\n        }\n\n        # Metrics básicos\n        location /metrics {\n            access_log off;\n            return 200 '# Nginx Basic Metrics\nnginx_connections_active $connections_active\nnginx_connections_accepted $connections_accepted\nnginx_connections_handled $connections_handled\n';\n            add_header Content-Type text/plain;\n        }\n\n        # Logs recentes\n        location /logs {\n            access_log off;\n            return 200 'Log files available:\n- /var/log/nginx/access.log\n- /var/log/nginx/error.log\n- /var/log/nginx/api_access.log\n';\n            add_header Content-Type text/plain;\n        }\n    }\n}